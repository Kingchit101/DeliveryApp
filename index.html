<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    .pin-input {
      width: 50px;
      height: 50px;
      font-size: 24px;
      text-align: center;
      margin: 0 5px;
      border: 2px solid #ccc;
      border-radius: 5px;
    }
    .pin-input:focus {
      border-color: #4f46e5;
      outline: none;
    }
    
    #scanner-container, #driver-scanner-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #scanner-container video, #driver-scanner-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .scanner-target {
      width: 250px;
      height: 150px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 10px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
    }

    .scanner-laser {
      position: absolute;
      width: 100%;
      height: 2px;
      background: red;
      top: 50%;
      animation: scan 2s infinite;
    }

    @keyframes scan {
      0% {
        top: 20%;
      }
      50% {
        top: 80%;
      }
      100% {
        top: 20%;
      }
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-badge.assigned {
      background-color: #FEF3C7;
      color: #92400E;
    }

    .status-badge.picked_up {
      background-color: #DBEAFE;
      color: #1E40AF;
    }

    .status-badge.delivered {
      background-color: #D1FAE5;
      color: #065F46;
    }

    .status-badge.unassigned {
      background-color: #F3F4F6;
      color: #4B5563;
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
      }
      
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
      
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="container mx-auto px-4 py-8">
    <!-- Login Screen -->
    <div v-if="!isLoggedIn" class="flex items-center justify-center min-h-screen">
      <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 class="text-2xl font-bold text-center mb-6">Delivery Management System</h1>
        <h2 class="text-xl font-semibold text-center mb-8">Enter PIN to Login</h2>
        
        <div class="flex justify-center mb-6">
          <input type="password" v-model="pin[0]" maxlength="1" class="pin-input" @keyup="moveFocus($event, 0)" ref="pin0">
          <input type="password" v-model="pin[1]" maxlength="1" class="pin-input" @keyup="moveFocus($event, 1)" ref="pin1">
          <input type="password" v-model="pin[2]" maxlength="1" class="pin-input" @keyup="moveFocus($event, 2)" ref="pin2">
          <input type="password" v-model="pin[3]" maxlength="1" class="pin-input" @keyup="moveFocus($event, 3)" ref="pin3">
        </div>
        
        <div v-if="loginError" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
          <p v-text="loginError"></p>
        </div>
        
        <button 
          @click="login" 
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline"
          :disabled="!isPinComplete"
        >
          Login
        </button>
      </div>
    </div>

    <!-- Main App (after login) -->
    <div v-if="isLoggedIn">
      <!-- Navigation -->
      <nav class="mb-8">
        <div class="flex justify-between items-center">
          <h1 class="text-2xl font-bold">Delivery Management System</h1>
          <div class="flex space-x-4">
            <button @click="showPage('home')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Home</button>
            <button @click="showPage('scan')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Scan</button>
            <button @click="showPage('dashboard')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Dashboard</button>
            <button @click="showPage('driver')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Driver</button>
            <button @click="logout" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">Logout</button>
          </div>
        </div>
      </nav>

      <!-- Home Page -->
      <div v-if="currentPage === 'home'" class="text-center py-12">
        <h2 class="text-3xl font-bold mb-4">Welcome to the Delivery Management System</h2>
        <p class="text-lg mb-8">Manage your deliveries efficiently with Excel integration</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="text-4xl text-blue-500 mb-4">📦</div>
            <h3 class="text-xl font-semibold mb-2">Scan Cartons</h3>
            <p class="mb-4">Scan and record cartons for delivery</p>
            <button @click="showPage('scan')" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Start Scanning</button>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="text-4xl text-blue-500 mb-4">🚚</div>
            <h3 class="text-xl font-semibold mb-2">Driver Portal</h3>
            <p class="mb-4">View and confirm assigned deliveries</p>
            <button @click="showPage('driver')" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Access Portal</button>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="text-4xl text-blue-500 mb-4">📊</div>
            <h3 class="text-xl font-semibold mb-2">Dashboard</h3>
            <p class="mb-4">Manage and assign cartons to vehicles</p>
            <button @click="showPage('dashboard')" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">View Dashboard</button>
          </div>
        </div>
      </div>

      <!-- Scan Page -->
      <div v-if="currentPage === 'scan'" class="max-w-md mx-auto">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">Scan Cartons</h2>
            <p class="text-gray-600">Scan carton barcodes to record for delivery</p>
          </div>
          <div class="p-6 space-y-4">
            <div v-if="!scanning">
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <div class="text-4xl text-gray-400 mb-4">📷</div>
                <p class="text-gray-500 mb-4">Press the button below to start scanning carton barcodes</p>
                <button @click="startScanning" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                  Start Scanning
                </button>
              </div>
            </div>
            <div v-else>
              <div class="relative overflow-hidden rounded-lg aspect-[4/3] bg-black mb-4">
                <div id="scanner-container">
                  <div class="scanner-overlay">
                    <div class="scanner-target">
                      <div class="scanner-laser"></div>
                    </div>
                  </div>
                </div>
                <button @click="simulateScan" class="absolute bottom-4 right-4 px-3 py-1 bg-white text-gray-800 rounded text-sm">
                  Simulate Scan
                </button>
              </div>
              <button @click="stopScanning" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                Stop Scanning
              </button>
            </div>
            
            <div v-if="pendingScans.length > 0" class="mt-6">
              <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-medium">Scanned Items ({{ pendingScans.length }})</h3>
                <button 
                  @click="submitScans" 
                  class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
                >
                  Confirm All
                </button>
              </div>
              <div class="space-y-2 max-h-60 overflow-y-auto">
                <div v-for="(item, i) in pendingScans" :key="i" class="flex items-center justify-between p-2 text-sm border rounded-md">
                  <span>{{ item }}</span>
                  <button @click="removeScannedItem(i)" class="text-red-500 hover:text-red-700">
                    ✕
                  </button>
                </div>
              </div>
            </div>
            
            <div v-if="confirmedScans.length > 0" class="mt-6">
              <h3 class="text-lg font-medium mb-2">Confirmed Scans ({{ confirmedScans.length }})</h3>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                <div v-for="(item, i) in confirmedScans.slice(0, 5)" :key="i" class="flex items-center justify-between p-2 text-sm border rounded-md">
                  <span>{{ item }}</span>
                  <span class="text-green-500">✓</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div v-if="currentPage === 'dashboard'" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Unassigned Cartons -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-xl font-semibold flex items-center">
              <span class="mr-2">📦</span> Unassigned Cartons
            </h2>
            <p class="text-gray-600">Select cartons and assign them to vehicles</p>
          </div>
          <div class="p-6">
            <div v-if="unassignedCartons.length > 0" class="border rounded-md overflow-hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      <input type="checkbox" @change="toggleSelectAll" :checked="selectAll">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Carton ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Scanned At
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="carton in unassignedCartons" :key="carton.ID" class="hover:bg-gray-50 cursor-pointer" @click="toggleSelectCarton(carton.ID)">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <input type="checkbox" :checked="selectedCartons.includes(carton.ID)" @click.stop>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">
                      {{ carton.ID }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ formatDate(carton.DateScanned) }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div v-else class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <div class="text-4xl text-gray-400 mb-4">📦</div>
              <p class="text-gray-500">No unassigned cartons</p>
            </div>
            
            <div v-if="unassignedCartons.length > 0" class="mt-4 grid grid-cols-3 gap-4">
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Vehicle</label>
                <select v-model="selectedVehicle" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                  <option value="">Select vehicle</option>
                  <option v-for="vehicle in vehicles" :key="vehicle.ID" :value="vehicle.ID">
                    {{ vehicle.Name }}
                  </option>
                </select>
              </div>
              <div class="flex items-end">
                <button 
                  @click="assignCartons" 
                  class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                  :disabled="selectedCartons.length === 0 || !selectedVehicle"
                >
                  Assign
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Assigned Cartons -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-xl font-semibold flex items-center">
              <span class="mr-2">🚚</span> Assigned Cartons
            </h2>
            <p class="text-gray-600">View cartons assigned to vehicles</p>
          </div>
          <div class="p-6">
            <div v-if="assignedCartons.length > 0" class="border rounded-md overflow-hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Carton ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Vehicle
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="carton in assignedCartons" :key="carton.ID">
                    <td class="px-6 py-4 whitespace-nowrap font-medium">
                      {{ carton.ID }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      {{ getVehicleName(carton.VehicleID) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span :class="['status-badge', carton.Status.toLowerCase()]">
                        {{ formatStatus(carton.Status) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div v-else class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <div class="text-4xl text-gray-400 mb-4">🚚</div>
              <p class="text-gray-500">No assigned cartons</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Driver Page -->
      <div v-if="currentPage === 'driver'" class="max-w-md mx-auto">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="p-6 border-b">
            <h2 class="text-xl font-semibold">Driver Portal</h2>
            <p class="text-gray-600">Enter your vehicle ID to see assigned cartons</p>
          </div>
          <div class="p-6 space-y-6">
            <div class="space-y-2">
              <label class="block text-sm font-medium text-gray-700">Vehicle ID</label>
              <div class="flex space-x-2">
                <input 
                  v-model="driverVehicleId" 
                  type="text" 
                  placeholder="e.g. TRUCK-001" 
                  class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                <button @click="loadDriverAssignments" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                  Load
                </button>
              </div>
            </div>
            
            <div v-if="driverAssignments.length > 0" class="space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-medium">Assigned Cartons</h3>
                <div class="text-xs text-gray-500">
                  {{ driverAssignments.filter(a => a.Status === 'delivered').length }} of {{ driverAssignments.length }} delivered
                </div>
              </div>
              
              <!-- Driver Scanning Interface -->
              <div v-if="!driverScanning" class="border-2 border-dashed border-blue-300 rounded-lg p-4 text-center bg-blue-50">
                <div class="text-2xl text-blue-500 mb-2">📱</div>
                <p class="text-blue-700 mb-3">Scan carton barcodes to confirm pickup</p>
                <button @click="startDriverScanning" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                  Start Scanning
                </button>
              </div>
              
              <div v-if="driverScanning" class="space-y-3">
                <div class="relative overflow-hidden rounded-lg aspect-[4/3] bg-black">
                  <div id="driver-scanner-container">
                    <div class="scanner-overlay">
                      <div class="scanner-target">
                        <div class="scanner-laser"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <button @click="stopDriverScanning" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                  Stop Scanning
                </button>
                <div v-if="lastScannedCarton" class="p-3 bg-green-100 border border-green-300 rounded-md text-center">
                  <p class="text-green-800">Last scanned: <strong>{{ lastScannedCarton }}</strong></p>
                </div>
              </div>
              
              <div class="border rounded-md overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Carton ID
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                      </th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Action
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="assignment in driverAssignments" :key="assignment.ID" :class="{'bg-blue-50': lastScannedCarton === assignment.ID}" :data-carton-id="assignment.ID">
                      <td class="px-6 py-4 whitespace-nowrap font-medium">
                        {{ assignment.ID }}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <span :class="['status-badge', assignment.Status.toLowerCase()]">
                          {{ formatStatus(assignment.Status) }}
                        </span>
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        <button 
                          v-if="assignment.Status === 'assigned'" 
                          @click="confirmPickup(assignment.ID)"
                          class="p-1 text-blue-600 hover:text-blue-800"
                        >
                          Confirm Pickup
                        </button>
                        <button 
                          v-if="assignment.Status === 'picked_up'" 
                          @click="confirmDelivery(assignment.ID)"
                          class="p-1 text-green-600 hover:text-green-800"
                        >
                          Confirm Delivery
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div v-else-if="driverVehicleId && !loadingDriverData" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <div class="text-4xl text-gray-400 mb-4">🚚</div>
              <p class="text-gray-500">No cartons assigned to this vehicle</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Toast Notifications -->
      <div class="fixed bottom-4 right-4 z-50">
        <div v-for="(toast, index) in toasts" :key="index" class="mb-2 p-4 rounded-md shadow-lg max-w-md" :class="toastClasses(toast)">
          <div class="flex items-center">
            <div class="flex-shrink-0 mr-2" v-if="toast.type === 'success'">✅</div>
            <div class="flex-shrink-0 mr-2" v-else-if="toast.type === 'error'">❌</div>
            <div class="flex-shrink-0 mr-2" v-else>ℹ️</div>
            <div>
              <p class="font-medium" v-text="toast.title"></p>
              <p class="text-sm" v-text="toast.message"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    const app = createApp({
      setup() {
        // Authentication state
        const isLoggedIn = ref(false);
        const pin = ref(['', '', '', '']);
        const loginError = ref('');
        
        // App state
        const currentPage = ref('home');
        const vehicles = ref([]);
        const cartons = ref([]);
        const scanning = ref(false);
        const pendingScans = ref([]);
        const confirmedScans = ref([]);
        const selectedCartons = ref([]);
        const selectedVehicle = ref('');
        const selectAll = ref(false);
        const driverVehicleId = ref('');
        const driverAssignments = ref([]);
        const loadingDriverData = ref(false);
        const scanner = ref(null);
        const driverScanner = ref(null);
        const driverScanning = ref(false);
        const lastScannedCarton = ref('');
        const toasts = ref([]);

        // API URL - change this to match your server
        // In production, this should be your deployed server URL
        const API_URL = window.location.hostname === 'localhost' 
          ? 'http://localhost:3001/api' 
          : '/api'; // This assumes your API is on the same domain in production

        // Computed properties
        const isPinComplete = computed(() => {
          return pin.value.every(digit => digit.length === 1);
        });
        
        const unassignedCartons = computed(() => {
          return cartons.value.filter(c => c.Status === 'unassigned');
        });

        const assignedCartons = computed(() => {
          return cartons.value.filter(c => c.Status !== 'unassigned');
        });

        // Check for saved login state on mount
        onMounted(() => {
          // Check if user is already logged in
          const savedLoginState = localStorage.getItem('isLoggedIn');
          if (savedLoginState === 'true') {
            isLoggedIn.value = true;
            loadData();
          }
          
          // Check if PIN inputs need references
          setTimeout(() => {
            const pinInputs = document.querySelectorAll('.pin-input');
            pinInputs.forEach((input, index) => {
              input.id = `pin${index}`;
            });
          }, 100);
        });

        // Methods
        const moveFocus = (event, index) => {
          // Move to next input when a digit is entered
          if (event.key !== 'Backspace' && index < 3 && pin.value[index].length === 1) {
            const nextInput = document.getElementById(`pin${index + 1}`) || 
                             document.querySelector(`[ref="pin${index + 1}"]`);
            if (nextInput) nextInput.focus();
          }
          
          // Move to previous input on backspace
          if (event.key === 'Backspace' && index > 0 && pin.value[index].length === 0) {
            const prevInput = document.getElementById(`pin${index - 1}`) || 
                             document.querySelector(`[ref="pin${index - 1}"]`);
            if (prevInput) prevInput.focus();
          }
        };
        
        const login = async () => {
          if (!isPinComplete.value) return;
          
          const pinValue = pin.value.join('');
          
          try {
            const response = await fetch(`${API_URL}/login`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ pin: pinValue })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Invalid PIN');
            }
            
            // Login successful
            isLoggedIn.value = true;
            loginError.value = '';
            
            // Save login state to localStorage
            localStorage.setItem('isLoggedIn', 'true');
            
            // Load initial data
            loadData();
          } catch (error) {
            console.error('Login error:', error);
            loginError.value = error.message || 'Invalid PIN';
            
            // Clear PIN
            pin.value = ['', '', '', ''];
            
            // Focus first input
            setTimeout(() => {
              const firstInput = document.getElementById('pin0') || 
                               document.querySelector('[ref="pin0"]');
              if (firstInput) firstInput.focus();
            }, 100);
          }
        };
        
        const logout = () => {
          isLoggedIn.value = false;
          pin.value = ['', '', '', ''];
          currentPage.value = 'home';
          
          // Clear login state from localStorage
          localStorage.removeItem('isLoggedIn');
        };

        const showPage = (page) => {
          currentPage.value = page;
          if (page === 'dashboard') {
            loadData();
          }
        };

        const loadData = async () => {
          try {
            const [vehiclesResponse, cartonsResponse] = await Promise.all([
              fetch(`${API_URL}/vehicles`),
              fetch(`${API_URL}/cartons`)
            ]);

            if (!vehiclesResponse.ok || !cartonsResponse.ok) {
              throw new Error('Failed to fetch data from server');
            }

            vehicles.value = await vehiclesResponse.json();
            cartons.value = await cartonsResponse.json();
          } catch (error) {
            console.error('Error loading data:', error);
            showToast('Error', 'Failed to load data. Please check if the server is running.', 'error');
            
            // Don't log out the user on data load failure
            // This prevents the login loop issue
          }
        };

        const startScanning = () => {
          scanning.value = true;
          
          // Initialize scanner in the next tick to ensure DOM is ready
          setTimeout(() => {
            const scannerContainer = document.getElementById('scanner-container');
            if (!scannerContainer) return;
            
            // Configure advanced scanner options
            const config = {
              fps: 10,                     // Higher frames per second for better detection
              qrbox: { width: 250, height: 150 },
              formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.DATA_MATRIX
              ],
              experimentalFeatures: {
                useBarCodeDetectorIfSupported: true  // Use the built-in detector if available
              }
            };
            
            scanner.value = new Html5Qrcode('scanner-container');
            
            // Add visual feedback element
            const feedbackEl = document.createElement('div');
            feedbackEl.id = 'scan-feedback';
            feedbackEl.style.position = 'absolute';
            feedbackEl.style.bottom = '50px';
            feedbackEl.style.left = '0';
            feedbackEl.style.right = '0';
            feedbackEl.style.textAlign = 'center';
            feedbackEl.style.color = 'white';
            feedbackEl.style.padding = '8px';
            feedbackEl.style.borderRadius = '4px';
            feedbackEl.style.margin = '0 auto';
            feedbackEl.style.width = '80%';
            feedbackEl.style.maxWidth = '300px';
            feedbackEl.style.fontSize = '14px';
            feedbackEl.style.display = 'none';
            scannerContainer.appendChild(feedbackEl);
            
            // Start the scanner
            scanner.value.start(
              { facingMode: "environment" },
              config,
              onScanSuccess,
              onScanProgress
            ).catch(err => {
              console.error('Error starting scanner:', err);
              showToast('Camera Error', 'Could not access camera. Please check permissions.', 'error');
              scanning.value = false;
            });
          }, 100);
        };

        const onScanSuccess = (decodedText, decodedResult) => {
          // Show visual feedback
          const feedbackEl = document.getElementById('scan-feedback');
          if (feedbackEl) {
            feedbackEl.textContent = 'Barcode detected!';
            feedbackEl.style.backgroundColor = 'rgba(0, 200, 0, 0.7)';
            feedbackEl.style.display = 'block';
            setTimeout(() => {
              feedbackEl.style.display = 'none';
            }, 1000);
          }
          
          // Play a success sound
          const audio = new Audio('data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAGUACFhYWFhYWFhYWFhYWFhYWFhYWFvb29vb29vb29vb29vb29vb29vb3T09PT09PT09PT09PT09PT09PT0/Ly8vLy8vLy8vLy8vLy8vLy8vLy//////////////////////////8AAAA5TEFNRTMuMTAwAZYAAAAAAAAAABQ4JAMGQgAAOAAABlDGCH9iAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAADwAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sQxBYDwAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=');
          audio.play().catch(e => console.log('Audio play error:', e));
          
          // Format the barcode
          let formattedBarcode = decodedText;
          
          // Check if it's already in CARTON-XXX format
          if (!formattedBarcode.startsWith('CARTON-')) {
            // Extract numeric part if it exists
            const numericMatch = decodedText.match(/\d+/);
            const numericPart = numericMatch ? numericMatch[0] : decodedText;
            formattedBarcode = `CARTON-${numericPart}`;
          }
          
          // Store additional data if present in the barcode
          let additionalData = {};
          
          // Try to parse JSON data if present
          try {
            // Some barcodes might contain JSON data
            if (decodedText.includes('{') && decodedText.includes('}')) {
              const jsonMatch = decodedText.match(/{.*}/);
              if (jsonMatch) {
                additionalData = JSON.parse(jsonMatch[0]);
              }
            }
          } catch (e) {
            console.log('No JSON data in barcode');
          }
          
          // Add to pending scans if not already there
          if (!pendingScans.value.includes(formattedBarcode)) {
            pendingScans.value.push(formattedBarcode);
            
            // Store additional data if found
            if (Object.keys(additionalData).length > 0) {
              localStorage.setItem(`barcode_data_${formattedBarcode}`, JSON.stringify(additionalData));
            }
            
            showToast('Barcode Detected', `Added ${formattedBarcode} to scan list`, 'success');
          } else {
            showToast('Duplicate Barcode', `${formattedBarcode} is already in the scan list`, 'info');
          }
        };

        const onScanProgress = (errorMessage, status) => {
          // Handle scan progress and errors
          const feedbackEl = document.getElementById('scan-feedback');
          if (feedbackEl && status !== Html5QrcodeScannerState.NOT_STARTED) {
            if (errorMessage) {
              // Only show certain errors to avoid flooding the UI
              if (errorMessage.includes('No barcode or QR code detected')) {
                // This is normal during scanning, don't show it
                feedbackEl.style.display = 'none';
              } else {
                feedbackEl.textContent = 'Scanning...';
                feedbackEl.style.backgroundColor = 'rgba(0, 0, 200, 0.7)';
                feedbackEl.style.display = 'block';
              }
            }
          }
        };

        const stopScanning = () => {
          if (scanner.value) {
            scanner.value.stop().then(() => {
              scanning.value = false;
              scanner.value = null;
              
              // Remove the feedback element
              const feedbackEl = document.getElementById('scan-feedback');
              if (feedbackEl) {
                feedbackEl.remove();
              }
            }).catch(err => {
              console.error('Error stopping scanner:', err);
            });
          } else {
            scanning.value = false;
          }
        };

        const startDriverScanning = () => {
          driverScanning.value = true;
          
          // Initialize scanner in the next tick to ensure DOM is ready
          setTimeout(() => {
            const scannerContainer = document.getElementById('driver-scanner-container');
            if (!scannerContainer) return;
            
            // Configure advanced scanner options
            const config = {
              fps: 10,
              qrbox: { width: 250, height: 150 },
              formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.DATA_MATRIX
              ],
              experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
              }
            };
            
            driverScanner.value = new Html5Qrcode('driver-scanner-container');
            
            // Add visual feedback element
            const feedbackEl = document.createElement('div');
            feedbackEl.id = 'driver-scan-feedback';
            feedbackEl.style.position = 'absolute';
            feedbackEl.style.bottom = '50px';
            feedbackEl.style.left = '0';
            feedbackEl.style.right = '0';
            feedbackEl.style.textAlign = 'center';
            feedbackEl.style.color = 'white';
            feedbackEl.style.padding = '8px';
            feedbackEl.style.borderRadius = '4px';
            feedbackEl.style.margin = '0 auto';
            feedbackEl.style.width = '80%';
            feedbackEl.style.maxWidth = '300px';
            feedbackEl.style.fontSize = '14px';
            feedbackEl.style.display = 'none';
            scannerContainer.appendChild(feedbackEl);
            
            // Start the scanner
            driverScanner.value.start(
              { facingMode: "environment" },
              config,
              onDriverScanSuccess,
              onDriverScanProgress
            ).catch(err => {
              console.error('Error starting driver scanner:', err);
              showToast('Camera Error', 'Could not access camera. Please check permissions.', 'error');
              driverScanning.value = false;
            });
          }, 100);
        };

        const onDriverScanSuccess = (decodedText, decodedResult) => {
          // Show visual feedback
          const feedbackEl = document.getElementById('driver-scan-feedback');
          if (feedbackEl) {
            feedbackEl.textContent = 'Barcode detected!';
            feedbackEl.style.backgroundColor = 'rgba(0, 200, 0, 0.7)';
            feedbackEl.style.display = 'block';
            setTimeout(() => {
              feedbackEl.style.display = 'none';
            }, 1000);
          }
          
          // Play a success sound
          const audio = new Audio('data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAFAAAGUACFhYWFhYWFhYWFhYWFhYWFhYWFvb29vb29vb29vb29vb29vb29vb3T09PT09PT09PT09PT09PT09PT0/Ly8vLy8vLy8vLy8vLy8vLy8vLy//////////////////////////8AAAA5TEFNRTMuMTAwAZYAAAAAAAAAABQ4JAMGQgAAOAAABlDGCH9iAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAADwAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sQxBYDwAABpAAAACAAADSAAAAEVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVU=');
          audio.play().catch(e => console.log('Audio play error:', e));
          
          // Format the barcode
          let formattedBarcode = decodedText;
          
          // Check if it's already in CARTON-XXX format
          if (!formattedBarcode.startsWith('CARTON-')) {
            // Extract numeric part if it exists
            const numericMatch = decodedText.match(/\d+/);
            const numericPart = numericMatch ? numericMatch[0] : decodedText;
            formattedBarcode = `CARTON-${numericPart}`;
          }
          
          // Check if this carton is assigned to this vehicle
          const carton = driverAssignments.value.find(c => c.ID === formattedBarcode);
          
          if (carton) {
            // Set as last scanned carton
            lastScannedCarton.value = formattedBarcode;
            
            // Highlight the row in the table
            setTimeout(() => {
              const row = document.querySelector(`tr[data-carton-id="${formattedBarcode}"]`);
              if (row) {
                row.classList.add('pulse-animation');
                setTimeout(() => {
                  row.classList.remove('pulse-animation');
                }, 2000);
              }
            }, 100);
            
            // Check if we need to update the status
            if (carton.Status === 'assigned') {
              confirmPickup(formattedBarcode);
            } else if (carton.Status === 'picked_up') {
              confirmDelivery(formattedBarcode);
            } else {
              showToast('Already Processed', `Carton ${formattedBarcode} is already ${carton.Status}`, 'info');
            }
          } else {
            showToast('Not Found', `Carton ${formattedBarcode} is not assigned to this vehicle`, 'error');
          }
        };

        const onDriverScanProgress = (errorMessage, status) => {
          // Handle scan progress and errors
          const feedbackEl = document.getElementById('driver-scan-feedback');
          if (feedbackEl && status !== Html5QrcodeScannerState.NOT_STARTED) {
            if (errorMessage) {
              // Only show certain errors to avoid flooding the UI
              if (errorMessage.includes('No barcode or QR code detected')) {
                // This is normal during scanning, don't show it
                feedbackEl.style.display = 'none';
              } else {
                feedbackEl.textContent = 'Scanning...';
                feedbackEl.style.backgroundColor = 'rgba(0, 0, 200, 0.7)';
                feedbackEl.style.display = 'block';
              }
            }
          }
        };

        const stopDriverScanning = () => {
          if (driverScanner.value) {
            driverScanner.value.stop().then(() => {
              driverScanning.value = false;
              driverScanner.value = null;
              
              // Remove the feedback element
              const feedbackEl = document.getElementById('driver-scan-feedback');
              if (feedbackEl) {
                feedbackEl.remove();
              }
            }).catch(err => {
              console.error('Error stopping driver scanner:', err);
            });
          } else {
            driverScanning.value = false;
          }
        };

        const simulateScan = () => {
          // Generate different types of test barcodes
          const barcodeTypes = [
            // Simple numeric barcode
            () => `${Math.floor(1000 + Math.random() * 9000)}`,
            
            // Barcode with prefix
            () => `BC-${Math.floor(1000 + Math.random() * 9000)}`,
            
            // Barcode with JSON data
            () => `ITEM-${Math.floor(1000 + Math.random() * 9000)}{\"weight\":\"${(Math.random() * 10).toFixed(1)}kg\"}`,
            
            // EAN-like barcode
            () => `${Math.floor(10000000000000 + Math.random() * 90000000000000)}`
          ];
          
          // Pick a random barcode type
          const randomType = barcodeTypes[Math.floor(Math.random() * barcodeTypes.length)];
          const mockBarcode = randomType();
          
          // Process the simulated barcode
          onScanSuccess(mockBarcode, { format: "CODE_128", rawBytes: [] });
        };
        
        const removeScannedItem = (index) => {
          pendingScans.value.splice(index, 1);
        };
        
        const submitScans = async () => {
          if (pendingScans.value.length === 0) return;
          
          try {
            // Prepare cartons data with any additional information
            const cartonsData = pendingScans.value.map(cartonId => {
              // Check if we have additional data stored
              const additionalDataStr = localStorage.getItem(`barcode_data_${cartonId}`);
              let additionalData = {};
              
              if (additionalDataStr) {
                try {
                  additionalData = JSON.parse(additionalDataStr);
                } catch (e) {
                  console.error('Error parsing additional data:', e);
                }
              }
              
              return {
                id: cartonId,
                additionalData
              };
            });
            
            const response = await fetch(`${API_URL}/cartons/batch`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ cartons: pendingScans.value, cartonsData })
            });
            
            if (!response.ok) {
              const result = await response.json();
              throw new Error(result.error || 'Failed to record cartons');
            }
            
            const result = await response.json();
            
            // Add to confirmed scans
            confirmedScans.value = [...pendingScans.value, ...confirmedScans.value];
            
            // Clear pending scans and their stored data
            pendingScans.value.forEach(cartonId => {
              localStorage.removeItem(`barcode_data_${cartonId}`);
            });
            pendingScans.value = [];
            
            showToast('Scans Confirmed', `Successfully recorded ${result.added.length} cartons`, 'success');
            
            // Refresh data if on dashboard
            if (currentPage.value === 'dashboard') {
              loadData();
            }
          } catch (error) {
            console.error('Error recording cartons:', error);
            showToast('Submission Failed', error.message || 'Could not record the scanned cartons', 'error');
            
            // Don't log out the user on API error
            // This prevents the login loop issue
          }
        };

        const toggleSelectCarton = (cartonId) => {
          if (selectedCartons.value.includes(cartonId)) {
            selectedCartons.value = selectedCartons.value.filter(id => id !== cartonId);
          } else {
            selectedCartons.value.push(cartonId);
          }
          
          // Update selectAll state
          selectAll.value = selectedCartons.value.length === unassignedCartons.value.length;
        };

        const toggleSelectAll = () => {
          selectAll.value = !selectAll.value;
          
          if (selectAll.value) {
            selectedCartons.value = unassignedCartons.value.map(c => c.ID);
          } else {
            selectedCartons.value = [];
          }
        };

        const assignCartons = async () => {
          if (!selectedVehicle.value || selectedCartons.value.length === 0) {
            showToast('Cannot Assign', 'Please select both cartons and a vehicle', 'error');
            return;
          }
          
          try {
            const response = await fetch(`${API_URL}/assign`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                cartonIds: selectedCartons.value,
                vehicleId: selectedVehicle.value
              })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Failed to assign cartons');
            }
            
            const result = await response.json();
            showToast('Cartons Assigned', `${selectedCartons.value.length} cartons assigned to ${getVehicleName(selectedVehicle.value)}`, 'success');
            
            // Reset selection
            selectedCartons.value = [];
            selectAll.value = false;
            
            // Refresh data
            loadData();
          } catch (error) {
            console.error('Error assigning cartons:', error);
            showToast('Assignment Failed', error.message || 'Could not assign cartons to vehicle', 'error');
          }
        };

        const loadDriverAssignments = async () => {
          if (!driverVehicleId.value) return;
          
          loadingDriverData.value = true;
          
          try {
            // Load all cartons
            const response = await fetch(`${API_URL}/cartons`);
            
            if (!response.ok) {
              throw new Error('Failed to load cartons');
            }
            
            const allCartons = await response.json();
            
            // Filter for this vehicle
            driverAssignments.value = allCartons.filter(c => 
              c.VehicleID === driverVehicleId.value && 
              ['assigned', 'picked_up', 'delivered'].includes(c.Status)
            );
            
            if (driverAssignments.value.length === 0) {
              showToast('No Assignments', `No cartons assigned to ${driverVehicleId.value}`, 'info');
            } else {
              showToast('Assignments Loaded', `${driverAssignments.value.length} cartons found for ${driverVehicleId.value}`, 'success');
            }
          } catch (error) {
            console.error('Error loading driver assignments:', error);
            showToast('Loading Failed', 'Could not load assignments', 'error');
          } finally {
            loadingDriverData.value = false;
          }
        };

        const confirmPickup = async (cartonId) => {
          try {
            const response = await fetch(`${API_URL}/pickup`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ 
                cartonId,
                vehicleId: driverVehicleId.value
              })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Failed to confirm pickup');
            }
            
            // Update local state
            driverAssignments.value = driverAssignments.value.map(a => 
              a.ID === cartonId ? { ...a, Status: 'picked_up' } : a
            );
            
            showToast('Pickup Confirmed', `${cartonId} marked as picked up`, 'success');
          } catch (error) {
            console.error('Error confirming pickup:', error);
            showToast('Confirmation Failed', error.message || 'Could not confirm pickup', 'error');
          }
        };

        const confirmDelivery = async (cartonId) => {
          try {
            const response = await fetch(`${API_URL}/deliver`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ cartonId })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Failed to confirm delivery');
            }
            
            // Update local state
            driverAssignments.value = driverAssignments.value.map(a => 
              a.ID === cartonId ? { ...a, Status: 'delivered' } : a
            );
            
            showToast('Delivery Confirmed', `${cartonId} marked as delivered`, 'success');
          } catch (error) {
            console.error('Error confirming delivery:', error);
            showToast('Confirmation Failed', error.message || 'Could not confirm delivery', 'error');
          }
        };

        const getVehicleName = (vehicleId) => {
          const vehicle = vehicles.value.find(v => v.ID === vehicleId);
          return vehicle ? vehicle.Name : vehicleId;
        };

        const formatDate = (dateString) => {
          if (!dateString) return '';
          const date = new Date(dateString);
          return date.toLocaleTimeString();
        };

        const formatStatus = (status) => {
          switch (status) {
            case 'assigned': return 'Assigned';
            case 'picked_up': return 'Picked Up';
            case 'delivered': return 'Delivered';
            default: return status.charAt(0).toUpperCase() + status.slice(1);
          }
        };

        const showToast = (title, message, type = 'info') => {
          const toast = { title, message, type, id: Date.now() };
          toasts.value.push(toast);
          
          // Auto-remove toast after 3 seconds
          setTimeout(() => {
            toasts.value = toasts.value.filter(t => t.id !== toast.id);
          }, 3000);
        };

        const toastClasses = (toast) => {
          switch (toast.type) {
            case 'success': return 'bg-green-100 text-green-800 border-l-4 border-green-500';
            case 'error': return 'bg-red-100 text-red-800 border-l-4 border-red-500';
            default: return 'bg-blue-100 text-blue-800 border-l-4 border-blue-500';
          }
        };

        return {
          // Auth state
          isLoggedIn,
          pin,
          loginError,
          isPinComplete,
          login,
          logout,
          moveFocus,
          
          // App state
          currentPage,
          vehicles,
          cartons,
          scanning,
          pendingScans,
          confirmedScans,
          selectedCartons,
          selectedVehicle,
          selectAll,
          driverVehicleId,
          driverAssignments,
          loadingDriverData,
          driverScanning,
          lastScannedCarton,
          unassignedCartons,
          assignedCartons,
          toasts,
          
          // Methods
          showPage,
          startScanning,
          stopScanning,
          startDriverScanning,
          stopDriverScanning,
          simulateScan,
          removeScannedItem,
          submitScans,
          toggleSelectCarton,
          toggleSelectAll,
          assignCartons,
          loadDriverAssignments,
          confirmPickup,
          confirmDelivery,
          getVehicleName,
          formatDate,
          formatStatus,
          toastClasses
        };
      }
    });

    app.mount('#app');
  </script>
</body>
</html>